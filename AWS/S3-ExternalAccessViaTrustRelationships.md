**External access to S3 buckets - AWS Account based access**

In scenarios where we have to provide access to external entities to our S3 buckets, the preferred solution, especially when the external entity runs their systems in AWS is to use trust-relationships instead of IAM user with shared secret.

1. Information required from External Entity

    a. AWS Account Id (this will be the principal that will be used to access the S3 bucket).

    b. External Id (this is a secret that is unique to this implementation and typically generated by the 3rd party, but, we can also generate it). Here are some pointers from the AWS documentation:

    The external ID can be any secret identifier that is known by you and the third party. For example, you can use an invoice ID between you and the third party, but do not use something that can be guessed, like the name or phone number of the third party

    [Providing access to AWS accounts owned by third parties - AWS Identity and Access Management](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_common-scenarios_third-party.html)

2. Information provided to External Entity

    a. S3 Bucket details (the name of the bucket)

    b. IAM Role details (arn for the role)

3. Steps to be done by you

    a. Create S3 bucket

    b. Create IAM Role with policies and trust relationships

4. Creating the IAM role

    a. In the AWS Console, navigate to the IAM service in the AWS menu, select "Roles" in the menu on the left, and select "Create Role".
    
    b. Select "Another AWS Account" in the menu at the top.
    
    c. Enter AWS Account Id for the external entity in the "Account ID" field. (from 1.1)
    
    d. Select the option "Require external ID" and enter the  external ID in the "External ID" field. (from 1.2)
    
    e. Continue to the permissions page.
    
    f. Select "Create policy", select "JSON". 
    
    g. Enter the policy below that enables access to S3. Select ‘Review Policy’ to finalize. Be sure to substitute the s3 bucket for <s3-bucket-name> (from (2.1)).

      ```
      {
          "Version": "2012-10-17",
          "Statement": [
              {
                  "Effect": "Allow",
                  "Action": [
                      "s3:ListBucket",
                      "s3:ListBucketMultipartUploads",
                      "s3:GetObject",
                      "s3:GetBucketPolicyStatus"
                  ],
                  "Resource": "arn:aws:s3:::<s3-bucket-name>"
              },
              {
                  "Effect": "Allow",
                  "Action": [
                      "s3:Get*",
                      "s3:PutObject",
                      "s3:DeleteObject",
                      "s3:AbortMultipartUpload",
                      "s3:ListMultipartUploadParts"
                  ],
                  "Resource": "arn:aws:s3:::<s3-bucket-name>/*"
              }
          ]
      }
      ```

  
    h. Finalize creating the policy by adding a name such as "externalEntityName-typeofData-s3-access", tags, and/or a description and then select "Create Policy" button. 
  
      (replace externalEntityName with name of entity this access is being provided to)

    i. Find the policy you just created by filtering by its name, select through to the Create Role screen.

    j. On the "Create Role" screen, enter the IAM Roles name such as "externalEntityName-typeofData-s3-access-role" and a description and select "Create Role" button.

    k. On the role detail screen, select the "Trust relationships" tab and then select "Edit trust relationship"

    l. Your trust should look something like this.
       
      replace: \<externalEntity_Account_Id\> with their AWS account Id and \<external-id\> with the secret they provided in (1.2) or generated by you for them.

      ```
      {
        "Version": "2012-10-17",
        "Statement": [
         {
          "Effect": "Allow",
          "Principal": {
              "AWS": "arn:aws:iam::<externalEntity_Account_Id>:root"
            },
          "Action": "sts:AssumeRole",
          "Condition": {
            "StringEquals": {
              "sts:ExternalId": "<external-id>"
              }
          }
          }
        ]
      }
      ```  
  
    m. Please take note of the IAM Role’s ARN to provide back to External entity.
